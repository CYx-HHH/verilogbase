# UART串口控制器

### 协议详解
#### 通信中发送端和接收端时钟是否一致

- 异步串口通信，UART：各自使用自身时钟，只需要两根线，RX、TX。频率相同（差别很小），相位不同。仅局限于时钟速度不快的前提，最高2Mbps。
- 数据信号是电压信号，信号变化（0-1-0）需要时间，如果时钟在信号变化期间读数据，会不稳定。时钟周期大的时候（变化少），读到信号变化区域的概率小；周期小翻转快的时候，读到信号变化区域概率大。

- 同步串口通信，USART：统一时钟，需要三根线，随路时钟CLK、TX、RX。
- 波特率，每秒传输bit数，bit/s，bps，等于时钟频率。这里时钟为9600bps。

UART通信状态：
- 空闲状态。
- 起始位 1b，拉低总线准备传输数据，给接收方准备时间，接收方时刻监测总线状态。
- 数据位 nbs，UART可以传任意bit数据，常规8bit。
- 校验位 1b，接收方检验数据是否匹配出错。
- 停止位 1b，总线拉回高电平，代表通信停止。
- 总线重回空闲状态。

#### 架构分析 
:  常用的CLK频率，50/100MHZ
串口线，输入线/接收信号线RX，发送线TX。串口属于全双工线。

    全双工，可同时收发数据，通常两个通道一个RX一个TX，常见UART。
    
    半双工，一个TX和一个RX，数据不能同时收发，常见RS485/232/422
    
    单工，只有一个方向/一个发送/接收通道。常见SPI

时钟先过PLL/锁相环，接UART串口驱动；驱动内部有产生波特率模块（时钟分频器）；波特率模块包括发送模块和接收模块，二者独立工作所以要分开。

#### UART主要模块
组成部分：时钟分频器、接收RX模块、发送TX模块、FIFO缓冲

模块主要输入有：
* 波特率可配置 
* 输入时钟频率可配置    
* 数据位宽度可配置
* 停止位宽度可配置
    
对接用户接口：数据位和校验位，对方的数据位和校验位;
发送和接收方握手协议，当双方都处于空闲状态时可以发送数据-ready本地空闲，vaild判定对方空闲。

    

#### 复位模块
复位信号问题：时钟分频器的复位信号和RX/TX等下面的模块周期不同，所以要设置单独的复位模块。

参数：设置复位周期（复位持续时间），输入信号，输出复位信号。

#### 发送
- 状态机-需要控制住状态机跳转，很麻烦
- 计数器-发送11bit
1. 计算校验位
   1. 奇校验
        检查有奇数个1，检测到偶数则拉高奇校验位；即奇数个00000001 0和偶数个00000011 1
   2. 偶校验
        同上，奇数个00000001 1和偶数个00000011 0
    
    用异或来检测数据中1的个数。组合逻辑按位异或会引入电路延时，用时序逻辑可以滤除毛刺干扰。因此时序逻辑更优。 ？为什么不按位异或呢

#### 接收
1. 亚稳态
        触发器的建立时间和保持时间在异步信号间有概率不满足。
        电压变化需要过程，会有跳变沿；当在跳变沿读取数据会不稳定。

   1. 解决亚稳态：打两拍，就是延迟一拍读（只要亚稳态在一个时钟周期内恢复）。
   2.打两拍，一般只适用于慢到快时钟，快到慢会漏数据。 
2.  计数和接收
    - 触发条件，起始位为0；
    - 移位实现接收队列，串转并
3. 接收端的奇偶校验，同发送端
    
#### Top设计
板机晶振的时钟一定要加锁相环，目的让输入时钟更加稳定，可以优化一些时钟问题。

一般时钟抖动是0.002；锁相信号是当时钟稳定之后拉高，不稳定的时候是低电平，是低电平复位。设计系统一般使用高电平复位，可以取反。

仿真文件就是tb文件/testbench，需要模拟时钟信号。

- Initial块初始化，过程语句阻塞赋值，只在仿真里可以使用，只执行一次，不可综合

- always语句，过程语句不可综合，重复执行的顺序执行语句。

电路设计要求复位信号和时钟上升沿是同步对齐的，可以用敏感触发条件实现。

优化设计
1. 把停止位去掉，减少空闲状态。
2. 亚稳态优化。
    - 时钟频差，累计误差。
        
        双方时钟差异会被累计放大（不可能有完全相同的信号，造成累积误差），造成亚稳态，也是造成误码的原因。

        因此不会有太长的串口数据，累计误差会被放很大。
        
    - 优化，对时钟做**动态校准/纠正**。
        
        理想情况，采样波形的中心点，数据最稳定。
        
        识别**起始位下降沿**开始产生时钟，即根据起始位动态产生时钟。

        起始位下降沿需要过采样。
3. 对接收方时钟过采样。
    
    采样的时钟频率比需要的频率更大，可以更准确的识别下降沿。

    双方统一时钟后不会产生亚稳态，就没必要打两拍了（留着也可以）。


#### 输入输出-DMA引擎，对接模块IO功能 
1. FIFO队列，作为异步时钟的缓冲。
